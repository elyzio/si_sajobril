{% extends 'main/layout1.html' %}
{% load static %}
{% load widget_tweaks %}
{% load custom_filters %}

{% block head_link %}
<style>
.hover-underline:hover {
    text-decoration: underline !important;
    cursor: pointer;
}
.text-decoration-none:hover {
    text-decoration: none !important;
}
.clickable-row:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}
.text-orange {
    color: #fd7e14;
}
</style>
{% endblock head_link %}

{% block contents %}

<section class="container">
    <header class="text-center font-weight-bold h5 mt-3 mb-3">Estatistiku Estudante</header>
    <header>
        <ol class="breadcrumb mb-1 mt-1">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Varanda</a></li>
            <li class="breadcrumb-item active" aria-current="page">Stats Estudante</li>
        </ol>
    </header>
    <div class="row">
        <!-- Student Class by Dep - START -->
        <div class="col-lg-6">
            <div class="card rounded-0">
                <div class="card-body">
                    <div class="card-title text-center h5 font-weight-bold">Table Student Class By Dep</div>
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                {% for header in headers %}
                                <th>{{ header }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in rows %}
                            <tr>
                                <th>{{ row.Class }}</th>
                                {% for dep in headers|slice:"1:" %}
                                <td class="{% if row|get_item:dep == 0 %}zero-count{% endif %}">
                                    <center>{{ row|get_item:dep }}</center>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div><!-- Student Class by Dep - FINISH -->
        
        <!-- Chart Student by gender - START -->
        <div class="col-lg-6">
            <div class="card rounded-0">
                <div class="card-body">
                    <div class="card-title text-center h5 font-weight-bold">Graph By gender</div>
                    <canvas id="genderByClassChart" width="400" height="200" class="mx-auto"></canvas>
                </div>
            </div>
        </div><!-- Chart Student by gender - FINISH -->
    </div>

    <!-- Second Row - Alumni and Transfer Statistics -->
    <div class="row mt-4">
        <!-- Alumni Statistics - START -->
        <div class="col-lg-4">
            <div class="card rounded-0 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fa fa-graduation-cap"></i> Alumni Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h3 class="text-success">{{alumni_count}}</h3>
                                <p class="mb-0">Total Alumni</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                {% for gender in alumni_by_gender %}
                                    <div class="mb-1">
                                        <span class="badge badge-{% if gender.estudante__Sexo == 'Mane' %}primary{% else %}pink{% endif %}">
                                            {{gender.estudante__Sexo}}: {{gender.count}}
                                        </span>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- Alumni Statistics - FINISH -->

        <!-- Transfer Statistics - START -->
        <div class="col-lg-4">
            <div class="card rounded-0 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fa fa-exchange"></i> Transfer Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            {% if transfer_in_approved > 0 %}
                            <a href="{% url 'students-transferred-in' %}" class="text-decoration-none">
                                <h4 class="text-success hover-underline">{{transfer_in_approved}}</h4>
                            </a>
                            {% else %}
                            <h4 class="text-success">{{transfer_in_approved}}</h4>
                            {% endif %}
                            <small>Transfer IN</small>
                        </div>
                        <div class="col-4">
                            {% if transfer_out_approved > 0 %}
                            <a href="{% url 'students-transferred-out' %}" class="text-decoration-none">
                                <h4 class="text-danger hover-underline">{{transfer_out_approved}}</h4>
                            </a>
                            {% else %}
                            <h4 class="text-danger">{{transfer_out_approved}}</h4>
                            {% endif %}
                            <small>Transfer OUT</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning">{{transfer_pending}}</h4>
                            <small>Pending</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h5 class="text-primary">{{internal_transfers}}</h5>
                            <small>Internal</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-orange">{{external_transfers}}</h5>
                            <small>External</small>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- Transfer Statistics - FINISH -->

        <!-- Student Summary - START -->
        <div class="col-lg-4">
            <div class="card rounded-0 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fa fa-users"></i> Student Summary</h5>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <a href="{% url 'students-active' %}" class="text-decoration-none">
                            <h3 class="text-primary hover-underline">{{active_students_count}}</h3>
                        </a>
                        <p class="mb-2">Active Students</p>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <a href="{% url 'students-alumni' %}" class="text-decoration-none">
                                    <h5 class="text-success hover-underline">{{alumni_count}}</h5>
                                </a>
                                <small>Graduated</small>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'students-transferred-out' %}" class="text-decoration-none">
                                    <h5 class="text-danger hover-underline">{{transfer_out_approved}}</h5>
                                </a>
                                <small>Transferred Out</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- Student Summary - FINISH -->
    </div>

    <!-- Transfer Chart Row -->
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="card rounded-0">
                <div class="card-body">
                    <div class="card-title text-center h5 font-weight-bold">Transfer Overview</div>
                    <canvas id="transferChart" width="400" height="200" class="mx-auto"></canvas>
                    
                    <!-- Internal vs External breakdown if there are approved transfers -->
                    {% if internal_transfers > 0 or external_transfers > 0 %}
                    <div class="mt-3">
                        <h6 class="text-center">Transfer Type Breakdown</h6>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <h5 class="text-primary mb-1">{{internal_transfers}}</h5>
                                    <small>Internal Transfers</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <h5 class="text-orange mb-1">{{external_transfers}}</h5>
                                    <small>External Transfers</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card rounded-0">
                <div class="card-body">
                    <div class="card-title text-center h5 font-weight-bold">Student Status Overview</div>
                    <canvas id="studentStatusChart" width="400" height="200" class="mx-auto"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>
</section>


{% endblock contents %}

{% block scripts %}
<!-- Charts JS
		============================================ -->
<script src="{% static 'notica/js/charts/Chart.js' %}"></script>

<script>{% include 'report/student/studentByGender.js' %}</script>

<script>
// Transfer Overview Chart - Fixed logic
const transferCtx = document.getElementById('transferChart').getContext('2d');

// Calculate total transfers to check if chart should be shown
const totalTransfers = {{transfer_in_approved}} + {{transfer_out_approved}} + {{transfer_pending}};

if (totalTransfers > 0) {
    const transferChart = new Chart(transferCtx, {
        type: 'doughnut',
        data: {
            labels: ['Transfer IN', 'Transfer OUT', 'Pending'],
            datasets: [{
                data: [
                    {{transfer_in_approved}}, 
                    {{transfer_out_approved}}, 
                    {{transfer_pending}}
                ],
                backgroundColor: [
                    '#28a745', // green
                    '#dc3545', // red  
                    '#ffc107'  // yellow
                ]
            }]
        },
        options: {
            responsive: true,
            legend: {
                position: 'bottom'
            },
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        const label = data.labels[tooltipItem.index];
                        const value = data.datasets[0].data[tooltipItem.index];
                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                        const percentage = Math.round((value / total) * 100);
                        return label + ': ' + value + ' (' + percentage + '%)';
                    }
                }
            }
        }
    });
} else {
    // Show "No Data" message when there are no transfers
    const canvas = document.getElementById('transferChart');
    const ctx = canvas.getContext('2d');
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#6c757d';
    ctx.fillText('No transfer data available', canvas.width / 2, canvas.height / 2);
}

// Student Status Overview Chart
const statusCtx = document.getElementById('studentStatusChart').getContext('2d');

// Calculate total to ensure we have data
const activeStudents = {{active_students_count}};
const alumniCount = {{alumni_count}};
const transferredOut = {{transfer_out_approved}};
const totalStudentData = activeStudents + alumniCount + transferredOut;

if (totalStudentData > 0) {
    const statusChart = new Chart(statusCtx, {
        type: 'pie',
        data: {
            labels: ['Active Students', 'Alumni', 'Transferred Out'],
            datasets: [{
                data: [activeStudents, alumniCount, transferredOut],
                backgroundColor: [
                    '#007bff', // blue
                    '#28a745', // green
                    '#dc3545'  // red
                ]
            }]
        },
        options: {
            responsive: true,
            legend: {
                position: 'bottom'
            },
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        const label = data.labels[tooltipItem.index];
                        const value = data.datasets[0].data[tooltipItem.index];
                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                        const percentage = Math.round((value / total) * 100);
                        return label + ': ' + value + ' (' + percentage + '%)';
                    }
                }
            }
        }
    });
} else {
    // Show "No Data" message
    const canvas = document.getElementById('studentStatusChart');
    const ctx = canvas.getContext('2d');
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillStyle = '#6c757d';
    ctx.fillText('No student data available', canvas.width / 2, canvas.height / 2);
}
</script>
{% endblock scripts %}